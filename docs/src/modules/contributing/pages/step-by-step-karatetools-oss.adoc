=== Identify

[cols="2,1",grid=rows]
|===
a|
[start=1]
. Create a `Feature Request` or `Bug Report` Issue in GitHub using the repository templates.
+
https://github.com/InditexTech/karatetools-oss/issues/new/choose[window=_blank]
+
The issues are labeled according to their type:

* `kind/feature`: a need to be covered, new functionalities or requests for specific features
* `kind/bug`: functional or technical incident in the karate tools

+
For example:
* `[Karate-Tools] RabbitMQ Support`
* `[Karate-Tools] ActiveMQ - Missing Fields in Message`

a|
image::steps-kt-oss-github-issue-types.png[role="no-border, zoom-in"]
image::steps-kt-oss-github-issue-examples.png[role="no-border, zoom-in"]

a|
[start=2]
. Create a new branch from the `develop` branch for the new feature or bug fix with the following naming convention: `<feature or bugfix>/GH-XXX-short-description`.
+
For example:

* `feature/GH-1-rabbitmq-support`
* `bugfix/GH-2-activemq-missing-fields`

a|
image::steps-kt-oss-github-branches.png[role="no-border, zoom-in"]
|===

=== Implement

[cols="2,1",grid=rows]
|===
a|
[start=3]
. Implement the corresponding *code changes*.
+
For example:

.. `karatetools-oss-clients`
* Add the `RabbitMQClientFactory` class.
* Add the instantiation of the `RabbitMQClientFactory` class to the `JMSClientFactory`.

.. `karatetools-oss-archetype`
* Add the client property (`includeJMSClient_ActiveMQ`) in `archetype-metadata.xml` file.
* Add the `configuration template` for the `rabbitmq` client in the `archetype-resources` folder.
* Add the generation logic in the `archetype-post-generate.groovy` file.

.. ...

a|
image::steps-kt-oss-new-jms-client-factory.png[role="no-border, zoom-in"]
image::steps-kt-oss-new-jms-client-config.png[role="no-border, zoom-in"]
|===

=== Test

==== Unit

[cols="2,1",grid=rows]
|===
a|
[start=4]
. Implement *unit* tests to verify the corresponding `codebase`.
+
For example:

.. `karatetools-oss-clients`
* Add the `unit tests` for the affected classes.
* Execute the `unit tests` to ensure that *code works as expected*
* Verify the corresponding code is properly *covered* by those tests (*`JaCoCo coverage >= {karatetools-unit-coverage-threshold}`*).
* Execute the `mutation tests` to ensure that the *unit tests are robust enough* (*`mutation coverage >= {karatetools-mutation-coverage-threshold}`*).

.. `karatetools-oss-archetype`
* Add the `archetype project test(s)` for the new client.
* Execute the `archetype tests` to ensure that the affected *template configurations are properly generated*.
* _This type of tests does not generate coverage nor require mutation tests_.

.. ...

a|
image::steps-kt-oss-new-jms-client-ide-unit-tests.png[role="no-border, zoom-in"]
image::steps-kt-oss-new-jms-client-ide-coverage.png[role="no-border, zoom-in"]
image::steps-kt-oss-new-jms-client-ide-mutation.png[role="no-border, zoom-in"]
image::steps-kt-oss-new-jms-client-ide-mutation-report.png[role="no-border, zoom-in"]

a|
[start=5]
. Execute all the codebase `unit tests` in the new branch using the `maven` command:
** `mvn clean verify -DskipITs -DfailIfNoTests=false -Dmaven.test.failure.ignore=false`
** `mvn surefire-report:report-only -DalwaysGenerateSurefireReport=true`
** Verify *all tests pass* (`code/target/site/surefire-report.html`) and the code coverage generated by unit tests (`code/jacoco-report-aggregate/target/site/jacoco-aggregate/index.html`) is at least *{karatetools-unit-coverage-threshold}*.

a|
image::steps-kt-oss-unit-surefire-report.png[role="no-border, zoom-in"]
image::steps-kt-oss-unit-jacoco-report.png[role="no-border, zoom-in"]

|===

==== Mutation

[cols="2,1",grid=rows]
|===
a|
[start=6]
. Execute all the codebase `mutation tests` in the new branch using the `maven` command:
** `mvn clean verify pitest:mutationCoverage pitest:report-aggregate-module -DskipITs`
** Verify *all tests pass* and the mutation coverage generated by mutation tests (`code/target/pit-reports/index.html`) is at least *{karatetools-mutation-coverage-threshold}*.

a|
image::steps-kt-oss-mutation-report.png[role="no-border, zoom-in"]

|===

==== Integration

[cols="2,1",grid=rows]
|===
a|
[start=7]
. Implement *integration* tests to verify the corresponding `codebase`.
+
For example:

.. `karatetools-oss-boot`
* Add the `rabbitmq` `docker` image in the `docker-compose.yml` test file.
* Update the `DockerHealthControllerIT` test to include the `rabbitmq` expected service.
* Add the `integration tests` for the affected classes.
* Execute the `integration tests` to ensure that the *code works as expected when integrated* with the new docker service.
.. ...

a|
image::steps-kt-oss-new-jms-client-ide-integration-tests.png[role="no-border, zoom-in"]

a|
[start=8]
. Execute all the codebase `integration tests` in the new branch using the `maven` command:
** `mvn clean verify -DskipUTs -DfailIfNoTests=false -Dmaven.test.failure.ignore=false`
** `mvn surefire-report:failsafe-report-only -DalwaysGenerateSurefireReport=true`
** Verify *all tests pass* (`code/target/site/failsafe-report.html`) and the code coverage generated by integration tests (`code/jacoco-report-aggregate/target/site/jacoco-aggregate-it/index.html`) is at least *{karatetools-integration-coverage-threshold}*.

a|
image::steps-kt-oss-integration-failsafe-report.png[role="no-border, zoom-in"]
image::steps-kt-oss-integration-jacoco-report.png[role="no-border, zoom-in"]

|===

==== Karate

[cols="2,1",grid=rows]
|===

a|
[start=9]
. Implement *karate* tests to verify the corresponding `codebase`.
+
For example:

.. `karatetools-oss-karate-test`
* Add the `karate tests` for the affected classes (config and feature files).
* Execute the `karate tests` to ensure that the *code works as expected as part of a karate module*.
.. ...

a|
image::steps-kt-oss-new-jms-client-ide-karate-tests.png[role="no-border, zoom-in"]

a|
[start=10]
. Execute all the codebase `karate tests` in the new branch following the steps defined in
** xref:karatetools-oss.adoc#karate-local-execution[Karate Local Execution (no code coverage), window=_blank].
** xref:karatetools-oss.adoc#karate-local-execution-with-code-coverage[Karate Local Execution with code coverage, window=_blank].
** Verify *all tests pass* and the code coverage generated by karate tests (`target/jacoco-e2e/index.html`) is at least *{karatetools-karate-coverage-threshold}*.

a|
image::steps-kt-oss-karate-karate-report.png[role="no-border, zoom-in"]
image::steps-kt-oss-karate-jacoco-report.png[role="no-border, zoom-in"]
|===

=== Document

[cols="2,1",grid=rows]
|===
a|
[start=11]
. Implement the corresponding *documentation*.
+
For example:

.. `jms-providers.adoc`: Add the new `Rabbit MQ` client to the list of supported JMS providers.
.. `jms-config-rabbbitmq.adoc`: Document the configuration properties for the `Rabbit MQ` client.
.. ...

a|
image::steps-kt-oss-new-jms-client-documentation.png[role="no-border, zoom-in"]

a|
[start=12]
. Launch the `documentation` locally to ensure that the *documentation is properly generated* following the steps defined in:
** xref:karatetools-oss.adoc#docs-local-build[Documentation Local Build, window=_blank].

a|
image::steps-kt-oss-new-jms-client-documentation-local.png[role="no-border, zoom-in"]

|===

=== Commit

[cols="2,1",grid=rows]
|===
a|
[start=13]
. Make clear and descriptive commits that explain the changes implemented in the new branch and push them to the repository.

a|
image::steps-kt-oss-github-commit.png[role="no-border, zoom-in"]

a|
[start=14]
. Make sure the change is reflected in the *Unreleased* section of the
`code/CHANGELOG.md` file, categorized according to the type of change implemented.
** *Added* for new features.
** *Changed* for changes in existing functionality.
** *Deprecated* for soon-to-be removed features.
** *Removed* for now removed features.
** *Fixed* for any bug fixes.
** *Security* in case of vulnerabilities.
+
For example:
+
[source,plaintext]
----
## [Unreleased]

### Added

- [#XXX](https://github.com/InditexTech/karatetools-oss/issues/XXX) To be completed

### Fixed

- [#YYY](https://github.com/InditexTech/karatetools-oss/issues/YYY) To be completed
----

a|
image::steps-kt-oss-github-changelog.png[role="no-border, zoom-in"]
|===

=== Pull Request

[cols="2,1",grid=rows]
|===
a|
[start=15]
. Create a `Pull Request` from the new branch to the `develop` branch.
** `unit`, `mutation`, `integration` and `karate` tests will be executed automatically.
** The `Pull Request` will be blocked if any of the tests fail or the coverage is below the defined thresholds.
. Await comments and discussions on the pull request. Make any necessary modifications based on the received feedback
. Once the pull request is approved, the contribution will be merged into the develop branch.
** The merge strategy to use is *`Squash and merge`*

a|
image::steps-kt-oss-github-pull-request-checks-blocked.png[role="no-border, zoom-in"]
|===

=== Release

[cols="2,1",grid=rows]
|===
a|
[start=18]
. Create the release pull request
.. Once all issues are addressed and merged into `develop`, create a pull request from `develop` branch to `main` using corresponding label:
* `release-type/major`: Defines the version as a major increment (x+1.y.z).
* `release-type/minor`: Defines the version as a minor increment (x.y+1.z).
* `release-type/patch`: Defines the version as a patch increment (x.y.z+1).
.. To release the documentation, the `release-docs` label must be added to the pull request.
* if the documentation release overrides an existing version the `release-docs/force` label must be added to the pull request.
a|
image::steps-kt-oss-github-release-pull-request.png[role="no-border, zoom-in"]
image::steps-kt-oss-github-release-labels.png[role="no-border, zoom-in"]

a|
[start=19]
. Wait for the release preview to finish
** The preview contains the proposed version number and the list of changes to include in the CHANGELOG.
** If the CHANGELOG is not updated, the release preview will fail.

a|
image::steps-kt-oss-github-release-preview.png[role="no-border, zoom-in"]

a|
[start=20]
. Merge the release pull request
** If the release preview is correct, you can merge the pull request.
*** The merge strategy to use is *`Create a merge commit`*
** The merge will trigger the release workflow.

a|
image::steps-kt-oss-github-release-workflow.png[role="no-border, zoom-in"]

a|
[start=21]
. Merge the sync pull request(s)
** The merge strategy to use is *`Create a merge commit`*
** Release changes and preparation for the next iteration are now coming to `develop` in a sync pull request (`Sync release X.X.X to develop`)
** Documentation changes (if any) and preparation for the next iteration are now coming to `develop` in a sync pull request (`Sync docs release X.X.X to develop`)

a|
image::steps-kt-oss-github-sync-pull-request.png[role="no-border, zoom-in"]
image::steps-kt-oss-github-sync-docs-pull-request.png[role="no-border, zoom-in"]
|===
